var w3 = new Array();
w3["safetythird"] = [ "Safety Third", ["safety third", "safety", "3 west", "three west", "next three west", "63rd"]];
w3["jfabi"] =    [ "Josh Josh", ["josh josh", "josh fabian", "jayfabi", "jfabi"], "grad student", "1", ["He created info lounge, where my infinite consciousness resides."], "December 29th", "Mexico" ]
w3["kkarthur"] = [ "The Bena", ["bena", "kwabena", "kkarthur", "kaykayarthur", "quabbin", "kwame", "corbin"], "junior", "2", ["It is not Kwabena's bedtime yet."], "August 29th", "", ["Are you sure it's not your bedtime yet?", "Playing too much Super Smash Brothers may be detrimental for your health."] ];
w3["akwasio"] =  [ "Akwasi",  ["akwasi", "akwasio"], "junior", "2", ["You probably owe him 5 dollars."], "February 15th", "", [] ];
w3["dfavela"]  = [ "Favela", ["favela", "david favela", "david villa", "dfavela"], "sophomore", "2A", [], "November 1st", "", ["Playing too much Super Smash Brothers may be detrimental for your health.", "You have quite a lovely singing voice."] ];
w3["joshbs"]   = [ "Posh Josh", ["soft josh", "posh josh", "frosh josh", "josh scherrer", "josh surer", "joshbs"], "sophomore", "3", ["His numerous nicknames include: Posh Josh, Soft Josh, Frosh Josh. Gosh! that's too many names."], "September 26th"];
w3["lolzhang"] = [ "Linda", ["linda", "linda zhang", "linda jong", "lolzhang"], "sophomore", "", [], "December 29th", "" ];
w3["rsyang"] =   [ "Rachel", ["rachel", "rachel yang", "rachel yong", "rsyang"], "sophomore", "", [] ];
w3["harlin"] =   [ "Harlin", ["harlin", "harlin lee", "harlot"], "senior", "6 2", ["Unfortunately, she abandoned this wing for Senior House."], "September 23rd", "somewhere in South Korea.", ["Baymax is sad that you abandoned this wing for Senior House."] ];
w3["gopalan"] =  [ "Deets", ["deets", "aditya", "gopalan", "aditya gopalan", "odysseu"], "sophomore", "6 1", [] ];
w3["huangjd"] =  [ "William", ["william", "junda", "william huang", "junda huang", "huangjd"], "senior", "6 2", ["He is probably trying to find a bug, but I'm too smart for that."], "May 26th", "somewhere in Texas", ["I'm sorry, but Baymax is free of bugs.", "Please stop trying to find bugs in Baymax."] ];
w3["cmzhang"] =  [ "Claire", ["claire", "claire z", "claire zhang", "cmzhang"], "senior", "2", [], "October 8th", "Houston" ];
w3["ncolant"] =  [ "Noelle", ["noelle", "noelle colant", "ncolant"], "junior", "10", ["So help her God."], "July 21st",  "Akron, Ohio", ["The life of a Course 10 must be pretty hard."] ];
w3["tianm"] =    [ "Tien", ["tien", "tian", "tian mi", "tianm", "dongfan"], "senior", "6 3", [], "December 24th", "" ];
w3["tiffwang"] = [ "Tiffany", ["tiffany", "tiffwang", "tiffany wang", "tiffanyhwang"], "junior", "1", ["Are you satisfied with your care?"], "on New Year's day!", ""];
w3["tricias"] =  [ "Tricia", ["tricia", "tricias", "tricia shi", "trisha", "pikachu"], "junior", "6 3", ["Are you satisfied with your care?"], "May 23rd", "West De Moines, Iowa" ];
w3["mabrams"] =  [ "Melanie", ["melanie", "melanie abrams", "mabrams"], "junior", "7", [], "September 2nd", "Cambridge, Massachusetts" ];
w3["zsheinko"] = [ "Zoe", ["zoe", "zoe sheinkoph",  "zsheinko"], "junior", "2", [] , "October 28th", "Seattle, Washington" ];
w3["tcheng17"] = [ "Tracy", ["tracy", "tracy chang", "tcheng17", "teaching17"], "junior", "2", [], "June 1st", "" ];
w3["jnation"] =  [ "Josh R.T.", ["josh rt", "josh nation", "jnation", "jaynation"], "G.R.T.", "2", ["Go Wildcats!"], "February 4th", "" ];
w3["saleeby"] =  [ "Kyle", ["kyle", "saleeby", "kyle saleeby"], "junior", "2", [], "September 20th", "" ];
w3["jamesvr"] =  [ "James", ["james", "james rugaveen", "james rogeveen", "jamesvr"], "sophomore", "", [], "December 12th", "" ];
w3["rliu42"] =   [ "Runpeng", ["ryanpayne", "ronpayne", "runpeng", "runpeng liu", "rliu42" ], "junior", "18C", [], "October 10th", "St. Louis, Missouri" ];
w3["dyhwong"] =  [ "David Wong", ["david wong", "dyhwong"], "junior", "6 3", [], "January 17th", "Morganville, New Jersey" ];
w3["xtnbui"] =   [ "Swun", ["xuan", "swan", "xuan bui", "swan bowie", "xtnbui", "1"], "junior", "6 3", [], "January 4th", "Maryland" ];
w3["eurahko"] =  [ "Yurah", ["eurah", "europe", "yuriko", "eurahko", "baymax"], "korean", "2", [], "May 17th", "somewhere in Korea." ];
w3["oropp"] =    [ "Or", ["or", "oropp", "or oppenheimer"], "sophomore", "2", [], "March 4th", "" ];
w3["rjliu"] =    [ "Raymond", ["raymond", "raymond liu", "rjliu"], "junior", "20", [], "January 20th", "" ];
w3["yzhang17"] = [ "Ya-ning", ["yaning", "yaning zhang", "yzhang17", "yinyang", "jenning"], "junior", "6 3", [] , "February 13th", "Chicago, Illinois" ];
w3["abrashen"] = [ "Aebra", ["abra", "avril", "abra shen"], "senior", "9", [], "June 2nd", "" ];
w3["psigrest"] = [ "Piper", ["piper", "piper sigrest", "psigrest"], "sophomore", "2", [], "April 27th", "" ];
w3["estrand"] =  [ "Elizabeth", ["elizabeth", "liz", "elizabeth strand", "estrand"], "sophomore", "2", [] ];
w3["ajjaeger"] = [ "Alexa", ["alexa", "alexa jaeger", "ajjaeger"], "sophomore", "2", [] ];
w3["jgoupil"] =  [ "Julia", ["julia", "jgoupil", "julia goupil", "jaygoupil"], "sophomore", "2", [] ];
w3["fishr"] =    [ "Ryan Fish", ["ryan", "fish", "ryan fish", "fishr"], "Masters of Engineering student", "2", [], "on Halloween!", "Wayne, Maine" ];
w3["normandy"] = [ "Norman", ["norman", "norman cow", "normandy"], "P.H.D. student", "22", ["Cow cow cow cow cow"], "February 5th", "the Big Apple" ];
w3["bmatt"] =    [ "Ben", ["ben", "ben mattinson", "bmatt"], "senior", "6 3", ["Spoooooky"], "January 21st", "" ];
w3["vhung"] =    [ "Victor", ["victor", "victor hung", "vhung"], "forever freshman", "6 2", ["Oh dear, I have too much to say about Victor."], "October 16th", "Vancouver, Canada" ];
w3["lcarter"] =  [ "Landon", ["landon", "landon carter", "lcarter", "alcarter"], "junior", "2", [], "May 3rd",  "North Carolina" ]
w3["ksmori"] =   [ "Sophie", ["sophie", "sophie mori", "ksmori", "que es morir", "ksmaury"], "sophomore", "24", [], "", "Marietta, Georgia" ];
w3["kkim17"] =   [ "Kristina", ["kristina", "christina", "kristina kim", "kkim17"] , "junior", "20", ["JoJo, have you been thinking again?"], "", "" ];
w3["zhoul"] =    [ "Leon", ["liang", "liang zhou", "leon", "zhoul"], "sophomore", "6 2", [], "", "" ];
w3["parke"]	 =   [ "Eddie Bear", ["eddie", "edward", "eddie bear", "edward park", "parke"], "sophomore", "6 3", [], "", "somewhere in Korea or Georgia" ];
w3["lwang32"] =  [ "Li", ["li", "li wang", "lwang32", "elwayne32", "elway32"], "sophomore", "2", [], "", "" ];
w3["llruan"] =   [ "Lisa", ["lisa", "lisa ruan", "lisa ruin", "llruan"], "sophomore", "18", [], "", "Lake Huron, Michigan" ];
w3["eman17"] =   [ "E-man", ["eman", "emmanuel", "eman17", "emmanuel fasil"], "junior", "6 3", [], "", ""];
w3["stalyc"] =   [ "Staley", ["staly", "stalyc", "daley", "staly chin"], "graduate", "2", [], "August 10th", "Bay Area"];
w3["lotusez3"] = [ "Elton", ["elton", "elton joe", "elton zhou", "lotusez3"], "junior", "7", [], "", ""];
w3["juesato"] =  [ "Jonathan", ["jonathan", "john", "jonathan usato", "jay usato", "juesato"], "junior", "18C", [], "", "Bay Area" ]
w3["jimmy42"] =  [ "Jimmy", ["jimmy", "jimmy wu", "jimmy42"], "sophomore", "6 3", [], "", ""]; 
w3["jtxiao"] =   [ "Justin", ["justin", "justin xiao", "justin chou", "jtxiao"], "junior", "8", [], "", ""];
w3["lahuang4"] = [ "Lauren", [ "lauren", "lauren huang", "lauren wong", "lahuang4" ], "junior", "6 2", "", ""];
w3["ccolombo"] = [ "Chris Colombo", [ "columbo", "dean colombo", "chris colombo", "chris", "ccolombo"], "Dean of Student Life", "", [], "", "" ];
w3["reif"] =     [ "Rafael Rife", [ "president", "president rife", "president right", "raphael wright", "reif" ], "President", "", ["I am smarter and more powerful than he will ever be."], "", ""];

var courses = new Array();
courses[""] = "";
courses["1"] = "Civil and Environmental Engineering";
courses["2"] = "Mechanical Engineering";
courses["2A"] = "Mechanical Engineering";
courses["3"] = "Materials Science and Engineering";
courses["4"] = "Architecture";
courses["5"] = "Chemistry";
courses["6 1"] = "Electrical Engineering";
courses["6 2"] = "Computer Science";
courses["6 3"] = "Computer Science";
courses["7"] = "Biology";
courses["8"] = "Physics";
courses["9"] = "Brain and Cognitive Sciences";
courses["10"] = "Chemical Engineering";
courses["11"] = "Urban Planning";
courses["12"] = "Earth and Planetary Sciences";
courses["14"] = "Economics";
courses["15"] = "Management";
courses["16"] = "Aerospace Engineering";
courses["17"] = "Political Science";
courses["18C"] = "Math with Computer Science";
courses["18"] = "Mathematics";
courses["20"] = "Biological Engineering";
courses["22"] = "Nuclear Science Engineering";
courses["24"] = "Linguistics and Philosophy";

var title = new Array();
title["1"] = "freshman";
title["2"] = "sophomore";
title["3"] = "junior";
title["4"] = "senior";
title["G"] = "graduate student";
title["P"] = "professor";
title[""]  = "faculty member";

function stringifySubject (s) {
	pr = new Array();
	pr[0] = [ /000(\d)/, "triple oh $1" ];
	pr[1] = [ /00([1-9]+)/, "double oh $1" ];
	pr[2] = [ /0([1-9]+)/, "oh $1" ];
	pr[3] = [ /([1-9])([1-9])([0-9])/, "$1 $2$3"]
	pr[4] = [ /\.00$/ , " hundred"];
	pr[5] = [ /\./ , " "];
	pr[6] = [ / II$/ , " 2"];
	pr[7] = [ / I$/ , " 1"];

	for (var i in pr) {
		s = s.replace(pr[i][0], pr[i][1]);
	}
	return s.trim();
} 

// Assumes input string, s, is digitized.
function parseSubject (s) {
	courseNo = ""; classNo = "";
	s = s.replace(/\s/, ".").replace(/[:\s]/g, "").replace(/[\.]+/, ".");
	if ( /\d{1,3}(\.)(S)?\d{2,4}/.test(s) ) {
		courseNo = s.split(".")[0];
		classNo = s.split(".")[1];
	} else if ( /\d{3,5}/.test(s) ) {
		if ( s.substring(0, 2) > 24 || /2\d{2,3}/.test(s) ) {
			courseNo = s.substring(0, 1);
			classNo = s.substring(1);
		} else {
			courseNo = s.substring(0, 2);
			classNo = s.substring(2);
		}
	}
	return {courseNo: courseNo, classNo: classNo};
}

function querySubject(s, callback) {
	var request = require('request');
	var result = { string: "Sorry, I don't know the M.I.T. subject number: " + stringifySubject(s.courseNo + " " + s.classNo) };
	var url = "http://student.mit.edu/catalog/m" + s.courseNo + "a.html";
	request(url, function (error, r, body) {
		if (error || r.statusCode != 200) {
			console.log(error);
			callback(new Error("Not found."));
		} else {
			if (body.indexOf("<h3>" + s.courseNo + "." + s.classNo) > -1) {
				var result = extractSubjectInfo(body, s);
				callback(null, result);
			} else {
				var url = "http://student.mit.edu/catalog/m" + s.courseNo + "b.html";
				request(url, function (error, r, body) {
					if (error || r.statusCode != 200) {
						console.log(error);
						callback(new Error("Not found."));
					} else {
						if (body.indexOf("<h3>" + s.courseNo + "." + s.classNo) > -1) {
							var result = extractSubjectInfo(body, s);
							callback(null, result);
						} else {
							var url = "http://student.mit.edu/catalog/m" + s.courseNo + "c.html";
							request(url, function (error, r, body) {
								if (error || r.statusCode != 200) {
									console.log(error);
									callback(new Error("Not found."));
								}
								if (body.indexOf("<h3>" + s.courseNo + "." + s.classNo) > -1) {
									var result = extractSubjectInfo(body, s);
									callback(null, result);
								} else {
									callback(new Error("Not found."));
								}
							});
						}
					}
				});
			}
		}
	});
}

function extractSubjectInfo(html, s) {
	var utils = require('../nigel/utils');
	result = {};
	result.courseNo = s.courseNo;
	result.classNo = s.classNo;
	result.fullSubject = s.courseNo + "." + s.classNo; 
	content = utils.between(html, "<h3>" + result.fullSubject, "<!--end-->").replace(/\<br\>/g, "\n").replace(/\<(.*?)\>/g, "");
	var data = content.split('\n');
	//console.log(data);
	result.subjectName = data[0].replace("J ", "").trim();
	for (i = 0; i < data.length; i++) {
		if ( data[i].indexOf("Lecture: ") > -1 ) {
			var lectureTime = utils.between(data[i], ": ", " (");
			var lectureLocation = utils.between(data[i], "(", ")");
			result.lecture = { 
							   times: lectureTime, 
							   building: lectureLocation.split("-")[0], 
							   room: lectureLocation.split("-")[1]
							 };
			result.description = data[i+4];
			result.professor = data[i+6].replace(/(Fall: )?(([A-Z]\. )*)?([\w]+)(.*)/, "$4");
			break;
		}	
	}
	if (result.lecture) {
		result.string = stringifySubject(result.fullSubject) + ", " + stringifySubject( (result.subjectName || "") ) + ", meets on " + stringifyLectureTimes(result.lecture.times) + " in building " + result.lecture.building + ", room " + result.lecture.room + ". " + ( result.professor ? "The subject is taught by Professor " + result.professor : "" ); 
	} else if (result.subjectName) {
		result.string = stringifySubject(result.fullSubject) + " is: " + result.subjectName + "."
	} else {
		return {string: "Sorry, I don't know the M.I.T. subject number: " +  stringifySubject(result.fullSubject) + "."};
	}
	console.log(result);
	return result;
}


function stringifyLectureTimes(s) {
	pr[0] = [/([A-Z])(\d{1,2}$)/, "$1. At $2 o\'clock"];
	pr[1] = ["M", "Mondays, "];
	pr[2] = ["T", "Tuesdays, "];
	pr[3] = ["W", "Wednesdays, "];
	pr[4] = ["R", "and Thursdays "];
	pr[5] = ["F", "and Fridays "];
	pr[6] = [/\./g, ":"];
	pr[7] = [/\-/, " to "]

	for (i in pr) {
		s = s.replace(pr[i][0], pr[i][1]);
	}
	return s;
}

exports.courses = courses;
exports.title = title;
exports.w3 = w3;
exports.parseSubject = parseSubject;
exports.stringifySubject = stringifySubject;
exports.querySubject = querySubject;